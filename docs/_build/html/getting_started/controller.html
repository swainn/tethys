

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The Controller &mdash; Tethys Platform 0.1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Tethys Platform 0.1.0 documentation" href="../index.html"/>
        <link rel="up" title="Getting Started" href="../getting_started.html"/>
        <link rel="next" title="URL Mapping" href="url_mapping.html"/>
        <link rel="prev" title="The View and Templating" href="view.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../index.html" class="fa fa-home"> Tethys Platform</a>
        
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../features.html">Tethys Platform</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../features.html#develop-web-apps">Develop Web Apps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#python-software-development-kit">Python Software Development Kit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#templating-and-gizmos">Templating and Gizmos</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#spatial-data">Spatial Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#data-store">Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#computing">Computing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#developer-tools">Developer Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#production-ready">Production Ready</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#install-the-dependencies">1. Install the Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#install-advanced-dependencies">2. Install Advanced Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#create-virtual-environment-and-install-tethys-platform">3. Create Virtual Environment and Install Tethys Platform</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#create-database-and-database-users">4. Create Database and Database Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#create-settings-file-and-configure-settings">5. Create Settings File and Configure Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#create-database-tables">6. Create Database Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#start-up-the-django-development-server">7. Start up the Django Development Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#what-s-next">What&#8217;s Next?</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../getting_started.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="scaffold.html">Create a New Tethys App Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="model.html">The Model and Persistent Stores</a></li>
<li class="toctree-l2"><a class="reference internal" href="view.html">The View and Templating</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">The Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="url_mapping.html">URL Mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="url_variables.html">Advanced Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="forms.html">User Input and Forms</a></li>
<li class="toctree-l2"><a class="reference internal" href="distribution.html">Distributing Apps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tethys_sdk.html">Software Development Kit</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tethys_sdk/dataset_services.html">Dataset Services API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tethys_sdk/persistent_store.html">Persistent Stores API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tethys_sdk/gizmos.html">Template Gizmos API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tethys_sdk/spatial_publishing.html">Spatial Data Publishing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tethys_sdk/geoprocessing.html">Geoprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tethys_sdk/visualizing.html">Data Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tethys_sdk/cloud_computing.html">High Performance Computing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../supplementary.html">Supplementary</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../supplementary/key_concepts.html">Key Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../supplementary/app_project.html">App Project Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../supplementary/app_class.html">App Base Class API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../supplementary/install_ubuntu.html">Ubuntu Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../supplementary/ckan_troubleshooting.html">CKAN Installation Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../supplementary/dev_environment.html">Setup Development Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../supplementary/production_deployment.html">Deploy Apps in Production</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../summary.html">Summary of References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Tethys Platform</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../getting_started.html">Getting Started</a> &raquo;</li>
      
    <li>The Controller</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../_sources/getting_started/controller.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="the-controller">
<h1>The Controller<a class="headerlink" href="#the-controller" title="Permalink to this headline">¶</a></h1>
<p><strong>Last Updated:</strong> November 17, 2014</p>
<p>The Controller component of MVC will be discussed in this part of the tutorial. The job of the controller is to coordinate between the View and the Model. Often this means querying a database and transforming the data to a format that the view expects it to be in. The Controller also handles most of the application logic such as processing and validating form data or launching model runs. In a Tethys app, controllers are simple Python functions.</p>
<p>Django is used to implement Tethys controllers but they are called &#8220;views&#8221; in Django. The <a class="reference external" href="https://docs.djangoproject.com/en/1.7/topics/http/views/">Writing Views</a> documentation for Django is a good reference for Tethys controllers. Note that URL mapping is handled differently in Tethys app development than in Django development and will be discussed in the <a class="reference internal" href="url_mapping.html"><em>URL Mapping</em></a> tutorial.</p>
<p>In this tutorial you will write a controller that will retrieve the data from your stream gage model and then pass it to the template that you created in the previous tutorial.</p>
<div class="section" id="make-a-new-controller">
<h2>Make a New Controller<a class="headerlink" href="#make-a-new-controller" title="Permalink to this headline">¶</a></h2>
<p>Recall that in <a class="reference internal" href="model.html"><em>The Model and Persistent Stores</em></a> tutorial you created an SQLAlchemy data model to store information about stream gages. You also created an initialization function that loaded some dummy data into your database. You will now add some logic to your controller to retrieve this data and pass it to the template.</p>
<p>Open your <tt class="file docutils literal"><span class="pre">controllers.py</span></tt> file located at <tt class="file docutils literal"><span class="pre">my_first_app/controllers.py</span></tt>. This file should contain a function called <tt class="docutils literal"><span class="pre">home</span></tt>. This function is the controller for the home page of your app. All controller functions must accept a request object and they must return a response object. The request object contains information about the HTTP request, including any form data that is submitted (more on this later). There are several ways to return a response object, but the most common way is to use the <tt class="docutils literal"><span class="pre">render()</span></tt> function provided by Django. This function requires three arguments: the request object, the template to be rendered, and the context dictionary.</p>
<p>Add the following imports to the top of the file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">.model</span> <span class="kn">import</span> <span class="n">SessionMaker</span><span class="p">,</span> <span class="n">StreamGage</span>
</pre></div>
</div>
<p>Then add a new controller function called <tt class="docutils literal"><span class="pre">map</span></tt> after the <tt class="docutils literal"><span class="pre">home</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Controller for map page.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Create a session</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">SessionMaker</span><span class="p">()</span>

    <span class="c"># Query DB for gage objects</span>
    <span class="n">gages</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">StreamGage</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="c"># Transform into GeoJSON format</span>
    <span class="n">geometries</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">gage</span> <span class="ow">in</span> <span class="n">gages</span><span class="p">:</span>
        <span class="n">gage_geometry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&quot;Point&quot;</span><span class="p">,</span>
        <span class="n">coordinates</span><span class="o">=</span><span class="p">[</span><span class="n">gage</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">gage</span><span class="o">.</span><span class="n">longitude</span><span class="p">],</span>
                             <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">gage</span><span class="o">.</span><span class="n">value</span><span class="p">})</span>
        <span class="n">geometries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gage_geometry</span><span class="p">)</span>

    <span class="n">geojson_gages</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;GeometryCollection&quot;</span><span class="p">,</span>
                     <span class="s">&quot;geometries&quot;</span><span class="p">:</span> <span class="n">geometries</span><span class="p">}</span>

    <span class="c"># Configure the map</span>
    <span class="n">map_options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;height&#39;</span><span class="p">:</span> <span class="s">&#39;500px&#39;</span><span class="p">,</span>
                   <span class="s">&#39;width&#39;</span><span class="p">:</span> <span class="s">&#39;100%&#39;</span><span class="p">,</span>
                   <span class="s">&#39;input_overlays&#39;</span><span class="p">:</span> <span class="n">geojson_gages</span><span class="p">}</span>

    <span class="c"># Pass variables to the template via the context dicitonary</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;map_options&#39;</span><span class="p">:</span> <span class="n">map_options</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;my_first_app/map.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<p>The new <tt class="docutils literal"><span class="pre">map</span></tt> controller queries the persistent store for the stream gages, converts the data into GeoJson format for the map, and configures the map options for the map Gizmo that is used in the template.</p>
<p>To query the database, an SQLAlchemy <tt class="docutils literal"><span class="pre">session</span></tt> object is needed. It is created using the <tt class="docutils literal"><span class="pre">SessionMaker</span></tt> object imported from the <tt class="file docutils literal"><span class="pre">model.py</span></tt> file. Querying is accomplished by using the <tt class="docutils literal"><span class="pre">query()</span></tt> method on the <tt class="docutils literal"><span class="pre">session</span></tt> object. The result is a list of <tt class="docutils literal"><span class="pre">StreamGage</span></tt> objects representing the records in the database.</p>
<p>The map is capable of consuming spatial data in a few formats including GeoJSON, so the <tt class="docutils literal"><span class="pre">map</span></tt> controller handles the job of converting the data from the list of <tt class="docutils literal"><span class="pre">StreamGage</span></tt> objects to GeoJSON format.</p>
<p>The map Gizmo that is used in the <tt class="file docutils literal"><span class="pre">map.html</span></tt> template requires a dictionary of configuration options called &#8220;map_options&#8221;. This is created in the controller and the <tt class="docutils literal"><span class="pre">input_overlays</span></tt> option is used to give the GeoJSON formatted stream gage data to the map.</p>
<p>Next, a template context dictionary is defined that contains all of the variables that you wish to be available for use in the template.</p>
<p>Finally, the <tt class="docutils literal"><span class="pre">render()</span></tt> function is used to create the response object. It is in the <tt class="docutils literal"><span class="pre">render()</span></tt> function that you specify the template that is to be rendered by the controller. In this case, the <tt class="file docutils literal"><span class="pre">map.html</span></tt> that you created in the last tutorial. Note that the path you provide to the template is relative to the template directory of your app: <tt class="docutils literal"><span class="pre">my_first_app/map.html</span></tt>.</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="url_mapping.html" class="btn btn-neutral float-right" title="URL Mapping">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="view.html" class="btn btn-neutral" title="The View and Templating"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Nathan Swain.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>